  
#!/bin/bash
# This script queries a specified Zerotier network and output all member names to a file suitable for /etc/hosts or an alternative hostfile for DNSMASQ
# echo "Usage: getnetworkmembers <APIKEY> <NETWORKID> <PATH/TO/OUTPUT/FILE>"
# CAUTION: curl and lq need to be installed.
# version 0.6
# by Kim Tholstorf (kim@tholstorf.dk)
# https://github.com/KimTholstorf/zerotier-scripts/
# (c)2020 Kim Tholstorf, Some rights reserved
#
#Change these 2 variables below to avoid the need for any runtime parameters
APIKEY="$1"
OUTPUTFILE="$2" #e.g. /etc/dnsmasq.zerotier
TLD=zt #Top level domain to use with the networkname - networkname.tld
#DOMAIN="$4" #e.g. example.com
#[[ -x "$(command -v jq)" ]] && { echo "Error: jq JSON processor is not installed or in PATH. See https://stedolan.github.io/jq/download/"; exit 1; }
[[ -z "$APIKEY" ]] && { echo "Error: API KEY must specified.\nUsage: getnetworkmembers <APIKEY> <NETWORKID> <PATH/TO/OUTPUT/FILE> <DOMAIN (optional)"; exit 1; }
[[ -z "$OUTPUTFILE" ]] && { echo "Error: OUTPUTFILE not specified.\nUsage: getnetworkmembers <APIKEY> <NETWORKID> <PATH/TO/OUTPUT/FILE> <DOMAIN (optional)"; exit 1; }
APIURL="https://my.zerotier.com/api"
NETWORKS=`curl -H "Authorization: bearer $APIKEY" $APIURL/network`
NETWORKLENGHT=`echo $NETWORKS | jq '. | length'`
echo "#Generated at $(date)" > $OUTPUTFILE
echo "#Found $NETWORKLENGHT networks" >> $OUTPUTFILE
NETWORKLENGHT=$(($NETWORKLENGHT - 1))
for n in $( seq 0 $NETWORKLENGHT )
    do
    #Loooing through the array of networks in the NETWORKS data.
    NETWORKID=`echo $NETWORKS | jq -r '.['$n'].id'`
    DOMAIN=`echo $NETWORKS | jq -r '.['$n'].config.name'`.$TLD #networkname.tld
    JSON=`curl -H "Authorization: bearer $APIKEY" $APIURL/network/$NETWORKID/member`
    ARRAYLENGHT=`echo $JSON | jq '. | length'`
    echo "#NetworkID $NETWORKID have $ARRAYLENGHT members" >> $OUTPUTFILE
    ARRAYLENGHT=$(($ARRAYLENGHT - 1))
    for i in $( seq 0 $ARRAYLENGHT )
        do
        #Loooing through the array of names in the JSON data. At each loop a line will be appended to the outputfile.
        echo $JSON | jq -r '.['$i'].config.ipAssignments[] + "#####" + .['$i'].name + "." + "'$DOMAIN'" | ascii_downcase' | sed 's/ /-/g' | sed 's/#/ /g' >> $OUTPUTFILE
        done #ARRYLENGHT members
    done #NETWORKLENGHT networks
